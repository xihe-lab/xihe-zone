name: PR å®¡æŸ¥é€šçŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, dev]

jobs:
  # 1. è‡ªåŠ¨åŒ–ä»£ç æ£€æŸ¥
  automated-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm install
        
      - name: è¿è¡Œ ESLint
        run: npm run lint || echo "ESLint æ£€æŸ¥å®Œæˆ"
        
      - name: æ„å»ºæ£€æŸ¥
        run: npm run build || echo "æ„å»ºæ£€æŸ¥å®Œæˆ"

  # 2. é€šçŸ¥ç™½æ³½
  notify-baize:
    runs-on: ubuntu-latest
    needs: automated-checks
    steps:
      - name: ç”Ÿæˆå®¡æŸ¥é€šçŸ¥
        run: |
          echo "ğŸ“– ç™½æ³½å®¡æŸ¥é€šçŸ¥"
          echo "==============="
          echo ""
          echo "**PR #${{ github.event.pull_request.number }}**"
          echo ""
          echo "- **æ ‡é¢˜ï¼š** ${{ github.event.pull_request.title }}"
          echo "- **ä½œè€…ï¼š** ${{ github.event.pull_request.user.login }}"
          echo "- **åˆ†æ”¯ï¼š** ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}"
          echo "- **æ—¶é—´ï¼š** $(date +'%Y-%m-%d %H:%M:%S')"
          echo "- **URLï¼š** ${{ github.event.pull_request.html_url }}"
          echo ""
          echo "è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼š${{ needs.automated-checks.result }}"
          echo ""
          echo "å¾…å®¡æŸ¥é¡¹ç›®ï¼š"
          echo "- [ ] ä»£ç é€»è¾‘æ­£ç¡®æ€§"
          echo "- [ ] æ¶æ„è®¾è®¡åˆç†æ€§"
          echo "- [ ] å®‰å…¨æ¼æ´æ£€æŸ¥"
          echo "- [ ] æ€§èƒ½å½±å“è¯„ä¼°"
          echo "- [ ] ä»£ç è§„èŒƒç¬¦åˆåº¦"
          
      - name: æ·»åŠ å®¡æŸ¥æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['awaiting-review']
            })
            
      - name: åˆ›å»ºå®¡æŸ¥è¯„è®º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ“– **ç™½æ³½å®¡æŸ¥ç³»ç»Ÿå·²å¯åŠ¨**
              
              è‡ªåŠ¨åŒ–æ£€æŸ¥å·²å®Œæˆï¼Œç­‰å¾…äººå·¥å®¡æŸ¥ã€‚
              
              **å®¡æŸ¥æ¸…å•ï¼š**
              - [ ] ä»£ç è´¨é‡
              - [ ] åŠŸèƒ½æ­£ç¡®æ€§
              - [ ] æ€§èƒ½å½±å“
              - [ ] å®‰å…¨æ€§
              - [ ] æ–‡æ¡£å®Œæ•´æ€§
              
              å®¡æŸ¥å®Œæˆåä¼šé€šçŸ¥ä½œè€…ã€‚
              `
            })
